---
title: "Theropod Teeth"
author: "Carolina Marques"
date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    fig_caption: yes
    force_captions: yes
    highlight: pygments
    number_sections: yes
    theme: cerulean
    df_print: paged
    toc: yes
    toc_depth: 4
    toc_float: yes
bibliography: biblio.bib  
link-citations: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE, warning=FALSE,message=FALSE}
library("ggplot2")
library(corrplot)
library("devtools")
library(readxl)
library(data.table)
library("RColorBrewer") 
library(kableExtra)
library(dplyr)
library(mgcv)
library(mgcViz)
```

This document was compiled on the `r Sys.time()` by `r Sys.getenv("USERNAME")`.


# Introduction

The data (Database_Hendrickx_2019_Dentes Poyos.xlsx) was obtained thanks to Elisabete Malafaia (EM), on the 31/07/2024, via external memory to Carolina Marques (CM). 

The data contains the information of several parameters obtained from measurements of theropod teeth and most of them are explained in the following schemes: 

![Fig 1: First scheme with the variabes obtained from the theropods teeth.](variables_teeth_image.png)

![Fig 2: Second scheme with the variabes obtained from the theropods teeth, in real teeth.](variables_teeth_image_real.png)

![Fig 3: Third scheme with the variabes obtained from the theropods teeth, in real teeth.](variables_teeth_image_more.png)

All of the above schemes come from @Hendrickx2015


# Reading the data 


```{r, warning=FALSE,message=FALSE}
data <- read_xlsx("Database_Hendrickx_2019_Dentes Poyos_Informacao idade.xlsx")
data[data == "?"] <- NA
data[data == "/"] <- NA

# Remove "?" from all columns
data[] <- lapply(data, function(x) {
  gsub("\\? ","", x)
})

# Remove "?" from all columns
data[] <- lapply(data, function(x) {
  gsub("\\?","", x)
})


data<-data[,-c(3,4,5)]
data[3:length(data)] <- apply(data[3:length(data)], 2,as.numeric)
data$`Taxa (Genus)`<-as.factor(data$`Taxa (Genus)`)
data$Epoch<-ifelse(data$Epoch=="'Middle Cretaceous'","Middle Cretaceous", data$Epoch)
data$Epoch<-as.factor(data$Epoch)
# Columns to be checked
columns_to_check <- c("MA", "MC", "MB", "DA", "DC", "DB", "MAVG", "DAVG", "DSDI")

# Replace values equal to 100 with 0 in the specified columns
data[columns_to_check] <- lapply(data[columns_to_check], function(x) {
  x[x == 100] <- 0
  return(x)
})

#data$Taxa<-as.factor(paste0(data$`Taxa (Genus)`,data$Maturity,sep=" "))



```


# Checking the data

## Summary of the table


```{r}
summary(data)
```


## Check first rows

```{r}
head(data)
```

## Tables

### Genus / Taxa Table

```{r}
taxa<-table(data$`Taxa (Genus)`)
data_taxa<-data.frame(taxa)
data_taxa<-data_taxa[order(data_taxa$Freq, decreasing = T), ]
data_taxa$ID<-1:nrow(data_taxa)
data_taxa
```


# Data Processing


## Removing columns that have more more missing value

```{r}
# Count the number of missing values in each column
missing_counts <- colSums(is.na(data))

# Remove columns with more than 15% missing values
data1_cleaned <- data[, missing_counts <= nrow(data)*0.1]
```



## Removing rows with NA values

```{r}
# Remove rows with any NA values
data1_cleaned <- na.omit(data1_cleaned)
data1_cleaned

```


## Subtracting the observations for the Taxa that have least observations



```{r}
lennn<-(ncol(data1_cleaned)-2)/2
taxa1<-table(data1_cleaned$`Taxa (Genus)`)
data1_cleanedd<-data.frame(taxa1)
data1_cleanedd<-data1_cleanedd[order(data1_cleanedd$Freq, decreasing = T), ]
data1_cleanedd$ID<-1:nrow(data1_cleanedd)
data1_cleanedd$`Taxa (Genus)`<-data1_cleanedd$Var1

data1_cleaned1<-data1_cleanedd[data1_cleanedd$Freq>lennn,]

data1_cleaned<-data1_cleaned[data1_cleaned$`Taxa (Genus)`%in%unique(data1_cleaned1$`Taxa (Genus)`),]

summary(data1_cleaned)
```



## Spliting the Log variables and the original

```{r}
# Select variables that contain "log" and the first column
selected_cols <- c(1,2, grep("Log", names(data1_cleaned)))

# Subset the data frame
data_log <- data1_cleaned[, selected_cols]

data_log

names(data_log)[-1]  <- gsub(" ", "_", names(data_log)[-1] )


# Identify columns that contain "log"
log_cols <- grep("Log", names(data1_cleaned))

# Include the first column
cols_to_keep <- setdiff(1:ncol(data1_cleaned), log_cols)

# Ensure the first column is included
cols_to_keep <- union(1, cols_to_keep)

# Subset the data frame
data_original <- data1_cleaned[, cols_to_keep]

data_original
```

# Visualization



## Original data

```{r}
correlation_matrix <- cor(data_original[, -c(1, 2)])
# Plot correlation matrix
corrplot(correlation_matrix, method = "color", type = "lower", 
         addCoef.col = "black", 
         tl.col = "black", 
         tl.srt = 45, 
         diag = FALSE, 
         order = "hclust", 
         col = colorRampPalette(c("blue", "white", "red"))(200))
```


## Log data


```{r}
correlation_matrix <- cor(data_log[, -c(1, 2)])
# Plot correlation matrix
corrplot(correlation_matrix, method = "color", type = "lower", 
         addCoef.col = "black", 
         tl.col = "black", 
         tl.srt = 45, 
         diag = FALSE, 
         order = "hclust", 
         col = colorRampPalette(c("blue", "white", "red"))(200))
```

```{r}
# Get the count of each unique value in the column
category_counts <- table(data_log$`Taxa (Genus)`)

# Filter unique values that have more than 0 observations
unique_values <- names(category_counts[category_counts > 0])

# Print the result
#print(unique_values)
```

# Saving the clean dataset

```{r}
write.csv(data_log,"teeth_data_log_genus_epoch.csv", row.names = FALSE)
write.csv(data_original,"teeth_data_genus_epoch.csv", row.names = FALSE)
```


# References